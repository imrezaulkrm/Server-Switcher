#!/bin/bash
# ========================================================
# Simple SSH Server Switcher with IP Preview
# Shows total servers, interactive selection, ssh <Host>
# ========================================================

CONFIG_FILE="$HOME/.ssh/config"

# Check if config exists
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "SSH config not found at $CONFIG_FILE"
    exit 1
fi

# Check fzf installed
if ! command -v fzf &> /dev/null; then
    echo "fzf not installed. Install it first."
    exit 1
fi

# Extract all HOST names (ignore wildcard '*')
HOSTS=($(grep -E '^HOST ' "$CONFIG_FILE" | awk '{print $2}' | grep -v '\*'))

# Check hosts found
if [[ ${#HOSTS[@]} -eq 0 ]]; then
    echo "No hosts found in SSH config."
    exit 1
fi

# Show total count
echo "Total servers found: ${#HOSTS[@]}"

# Interactive selection with live IP preview
SELECTED=$(printf "%s\n" "${HOSTS[@]}" | fzf \
    --prompt="Server> " \
    --height 20 \
    --border \
    --preview='
        awk -v host={} "
            \$1==\"HOST\" && \$2==host {found=1; next}
            found && \$1==\"HOSTNAME\" {print \"IP : \" \$2; exit}
            found && \$1==\"HOST\" {print \"IP : N/A\"; exit}
        " '"$CONFIG_FILE"'
    ' \
    --preview-window=right:40%
)

# Check if user selected a host
if [[ -z "$SELECTED" ]]; then
    echo "No server selected."
    exit 0
fi

# Connect using ssh + host name
echo "Connecting to $SELECTED..."
ssh "$SELECTED"
